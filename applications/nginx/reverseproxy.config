map $subdomain $subdomain_port {
  default 9000;
  www 9000;
  portainer 9000;
  registry 5000;
}

server {
    listen 80;
    listen [::]:80;
    server_name _;
    return 301 https://$host$request_uri;
}

server {
    listen              443 ssl;
    server_name         ~^(?P<subdomain>.+?)\.${delimited_domain_name}$;

    ssl_certificate     /etc/letsencrypt/live/${domain_name}/domain.crt;
    ssl_certificate_key /etc/letsencrypt/live/${domain_name}/domain.key;

    location / {
      # ... various proxy headers, then ...
      proxy_pass http://127.0.0.1:$subdomain_port;
      proxy_redirect off;
    }
}